<!DOCTYPE html>
  <meta charset="utf-8" />
  <title>WebSocket Test</title>
  <script language="javascript" type="text/javascript">

  //Adapt these settings for different tests:
  const MessagesPerInterval = 100;
  let Intervals = 100;

  const OverallMessages = MessagesPerInterval * Intervals;

  let wsUri = "ws://localhost:9090/";

  let MessageIndex = 1;
  let StartTimes = [];

  function run() {
    console.log('start');
    const Interval = setInterval(() => {
      for (let i = 0; i < MessagesPerInterval; ++i) {
        console.log("SENT: " + MessageIndex);
        websocket.send(MessageIndex);
        StartTimes[MessageIndex.toString()] = performance.now();
        MessageIndex += 1;
      }
      Intervals -= 1;
      if (Intervals === 0) {
        clearInterval(Interval);
      }
    }, 1);
  }

  let TimeSum = 0;
  let Count = 0;

  function message(evt) {
    const i = evt.data;
    const Time = performance.now() - StartTimes[i];
    TimeSum += Time;
    Count += 1;
    if (Count === OverallMessages) websocket.close();
    delete StartTimes[i];
    console.log(i + ' after ' + Time + 'ms');
  }

  function finish() {
    console.log(Count, 'messages sent, average response time:', TimeSum / Count);
  }

  console.log('Sending',Intervals,'StartTimes',MessagesPerInterval,'messgages each.');
  websocket = new WebSocket(wsUri);
  websocket.onopen = function(evt) {
    run();
  };
  websocket.onclose = function(evt) {
    finish();
  };
  websocket.onmessage = message;
  websocket.onerror = function(evt) { 
    console.error(evt.data);
  };

</script>

<h2>WebSocket Performance Test</h2>
